<!DOCTYPE html>
<html>
<head>
    <title>Event Ticketing - Payment Test</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        input, button { padding: 10px; font-size: 16px; }
        input { width: 300px; }
        button { background: #3498db; color: white; border: none; cursor: pointer; border-radius: 5px; }
        button:hover { background: #2980b9; }
        .status { margin-top: 20px; padding: 15px; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
<h1>üé´ Event Ticketing - Payment Test</h1>

<div class="form-group">
    <label>Event ID:</label>
    <input type="text" id="eventId" value="a9f5304c-d83b-4356-8250-0ee65aefe63e">
</div>

<div class="form-group">
    <label>User ID:</label>
    <input type="text" id="userId" value="013cd6ea-4c7d-4ed3-904e-b029f52dd6a6">
</div>

<div class="form-group">
    <label>Tickets:</label>
    <input type="number" id="ticketsCount" value="2" min="1">
</div>

<button onclick="createBookingAndPay()">üõí Create Booking & Pay</button>

<div id="status" class="status"></div>

<div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
    <h3>üìù How to Test Payment:</h3>
    <ol>
        <li>Click "Create Booking & Pay" button</li>
        <li>Razorpay popup will open with payment form</li>
        <li>Use these test card details:</li>
        <ul>
            <li><strong>Card Number:</strong> 4111 1111 1111 1111</li>
            <li><strong>Expiry:</strong> Any future date (e.g., 12/25)</li>
            <li><strong>CVV:</strong> Any 3 digits (e.g., 123)</li>
            <li><strong>Name:</strong> Any name</li>
        </ul>
        <li>Complete payment to test the flow</li>
    </ol>
</div>

<script>
    async function createBookingAndPay() {
    const statusDiv = document.getElementById('status');
    const eventId = document.getElementById('eventId').value;
    const userId = document.getElementById('userId').value;
    const ticketsCount = parseInt(document.getElementById('ticketsCount').value);

    if (!eventId || !userId) {
        showStatus('Please fill in Event ID and User ID', 'error');
        return;
    }

    try {
        showStatus('‚è≥ Creating booking...', 'warning');

        // Step 1: Create booking
        const bookingResponse = await fetch('/api/bookings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                eventId: eventId,
                userId: userId,
                ticketsCount: ticketsCount
            })
        });

        console.log('Booking Response Status:', bookingResponse.status);
        console.log('Booking Response Headers:', bookingResponse.headers);

        if (!bookingResponse.ok) {
            const errorText = await bookingResponse.text();
            console.log('Booking Error Response:', errorText);
            throw new Error(`Booking failed: ${errorText}`);
        }

        const bookingResult = await bookingResponse.json();
        console.log('Booking Result:', bookingResult);

        // Check if booking has the expected structure
        if (!bookingResult || !bookingResult.id) {
            throw new Error('Invalid booking response: missing booking ID');
        }

        showStatus('üí≥ Creating payment order...', 'warning');

        // Step 2: Create payment order (using the correct booking ID)
        const paymentResponse = await fetch(`/api/payments/create-order/${bookingResult.id}`, {
            method: 'POST'
        });

        if (!paymentResponse.ok) {
            const errorText = await paymentResponse.text();
            throw new Error(`Payment order creation failed: ${errorText}`);
        }

        const paymentResult = await paymentResponse.json();
        console.log('Payment Result:', paymentResult);

        if (!paymentResult.success || !paymentResult.paymentOrder) {
            throw new Error('Invalid payment order response');
        }

        showStatus('üîê Opening Razorpay checkout...', 'warning');

        // Step 3: Open Razorpay checkout
        const options = {
            key: paymentResult.paymentOrder.keyId,
            amount: paymentResult.paymentOrder.amount * 100,
            currency: paymentResult.paymentOrder.currency,
            order_id: paymentResult.paymentOrder.orderId,
            name: 'Event Ticketing Platform',
            description: `${ticketsCount} Event Tickets`,
            handler: async function(response) {
                showStatus('‚úÖ Verifying payment...', 'warning');

                try {
                    const verifyResponse = await fetch('/api/payments/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature,
                            booking_id: bookingResult.id
                        })
                    });

                    const verifyResult = await verifyResponse.json();

                    if (verifyResult.success) {
                        showStatus('üéâ Payment successful! Booking confirmed!', 'success');
                    } else {
                        showStatus('‚ùå Payment verification failed', 'error');
                    }
                } catch (error) {
                    showStatus('‚ùå Payment verification error: ' + error.message, 'error');
                }
            },
            prefill: {
                name: 'Test User',
                email: 'test@example.com',
                contact: '9999999999'
            },
            notes: {
                booking_id: bookingResult.id
            },
            theme: {
                color: '#3498db'
            },
            modal: {
                ondismiss: function(){
                    showStatus('‚ùå Payment cancelled by user', 'error');
                }
            }
        };

        const rzp = new Razorpay(options);
        rzp.open();

    } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        console.error('Full error:', error);
    }
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.className = `status ${type}`;
    statusDiv.innerHTML = message;
    statusDiv.style.display = 'block';
}


    function showStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.className = `status ${type}`;
        statusDiv.innerHTML = message;
        statusDiv.style.display = 'block';
    }
</script>
</body>
</html>